syntax = "proto3";

package data_stream.v1;

import "google/protobuf/timestamp.proto";

// A single payload processing contract: match -> transform -> validate
message PayloadContract {
  // CEL expression that determines if this contract applies to a given payload.
  // Evaluated against the raw payload; must return a boolean.
  // Use "true" for a contract that always matches.
  string match_expression = 1;

  // CEL expression that transforms the raw payload into JSON.
  // Only executed if match_expression evaluates to true.
  string transform_expression = 2;

  // JSON Schema string for validating the transformed output.
  string json_schema = 3;
}

// DataStreamDefinition holds payload contracts for data stream processing
message DataStreamDefinition {
  // Server-generated unique identifier
  string id = 1;

  // Organization that owns this definition
  string organization_id = 2;

  // Human-readable name for the definition
  string name = 3;

  // Ordered list of payload processing contracts
  repeated PayloadContract contracts = 4;

  // When the definition was created
  google.protobuf.Timestamp created_at = 5;

  // When the definition was last updated
  google.protobuf.Timestamp updated_at = 6;
}

// Request to create a data stream definition
message CreateDataStreamDefinitionRequest {
  // Organization that will own this definition
  string organization_id = 1;

  // Human-readable name for the definition
  string name = 2;

  // Ordered list of payload processing contracts
  repeated PayloadContract contracts = 3;
}

// Response containing the newly created definition
message CreateDataStreamDefinitionResponse {
  // The created definition with server-generated ID and timestamps
  DataStreamDefinition data_stream_definition = 1;
}

// Request to get a data stream definition by ID
message GetDataStreamDefinitionRequest {
  // Unique identifier of the definition to retrieve
  string id = 1;

  // Organization ID owning the definition
  string organization_id = 2;
}

// Response containing the requested definition
message GetDataStreamDefinitionResponse {
  // The requested definition
  DataStreamDefinition data_stream_definition = 1;
}

// Request to update a data stream definition
message UpdateDataStreamDefinitionRequest {
  // Unique identifier of the definition to update
  string id = 1;

  // Organization ID owning the definition
  string organization_id = 2;

  // Optional new name for the definition
  optional string name = 3;

  // Updated list of payload processing contracts.
  // When non-empty, replaces the entire contracts list.
  // When empty, contracts are left unchanged.
  repeated PayloadContract contracts = 4;
}

// Response containing the updated definition
message UpdateDataStreamDefinitionResponse {
  // The updated definition
  DataStreamDefinition data_stream_definition = 1;
}

// Request to delete a data stream definition
message DeleteDataStreamDefinitionRequest {
  // Unique identifier of the definition to delete
  string id = 1;

  // Organization ID owning the definition
  string organization_id = 2;
}

// Response for delete operation (empty on success)
message DeleteDataStreamDefinitionResponse {}

// Request to list data stream definitions for an organization
message ListDataStreamDefinitionsRequest {
  // Organization ID to filter definitions by
  string organization_id = 1;
}

// Response containing definitions for the organization
message ListDataStreamDefinitionsResponse {
  // List of definitions belonging to the organization
  repeated DataStreamDefinition data_stream_definitions = 1;
}

// Service for managing data stream definitions
service DataStreamDefinitionService {
  // Create a new definition
  rpc CreateDataStreamDefinition(CreateDataStreamDefinitionRequest) returns (CreateDataStreamDefinitionResponse);

  // Retrieve a definition by its ID
  rpc GetDataStreamDefinition(GetDataStreamDefinitionRequest) returns (GetDataStreamDefinitionResponse);

  // Update an existing definition
  rpc UpdateDataStreamDefinition(UpdateDataStreamDefinitionRequest) returns (UpdateDataStreamDefinitionResponse);

  // Delete a definition (fails if data streams reference it)
  rpc DeleteDataStreamDefinition(DeleteDataStreamDefinitionRequest) returns (DeleteDataStreamDefinitionResponse);

  // List all definitions for an organization
  rpc ListDataStreamDefinitions(ListDataStreamDefinitionsRequest) returns (ListDataStreamDefinitionsResponse);
}
