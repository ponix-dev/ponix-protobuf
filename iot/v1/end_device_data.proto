syntax = "proto3";

package iot.v1;

import "buf/validate/validate.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";

// Request to query end device data with histogram aggregation
message QueryEndDeviceDataRequest {
  // Organization ID (required, will be validated against user's access)
  string organization_id = 1 [(buf.validate.field).required = true];

  // Optional: Filter by specific device IDs. If empty, query all devices in org.
  repeated string end_device_ids = 2;

  // Time range for query (required)
  google.protobuf.Timestamp start_time = 3 [(buf.validate.field).required = true];
  google.protobuf.Timestamp end_time = 4 [(buf.validate.field).required = true];

  option (buf.validate.message).cel = {
    id: "end_time_after_start_time"
    message: "end_time must be after start_time"
    expression: "this.end_time > this.start_time"
  };

  // JSON path to the field to histogram (e.g., "flow_rate", "temperature")
  string field_path = 5 [(buf.validate.field).required = true];

  // Value bucket boundaries for histogram (Prometheus-style "le" buckets)
  // Example: [0, 10, 50, 100, 500] creates buckets: <=0, <=10, <=50, <=100, <=500, +Inf
  repeated double value_buckets = 6 [(buf.validate.field).repeated.min_items = 1];
}

// Response containing time-series histogram data
message QueryEndDeviceDataResponse {
  // Array of time-bucketed histograms
  repeated TimeSeriesHistogram time_series = 1;

  // Metadata about the query
  QueryMetadata metadata = 2;
}

// A single time bucket with histogram data
message TimeSeriesHistogram {
  // Start timestamp of this time bucket
  google.protobuf.Timestamp bucket_start = 1;

  // End timestamp of this time bucket
  google.protobuf.Timestamp bucket_end = 2;

  // Prometheus-style histogram buckets (cumulative counts)
  repeated HistogramBucket buckets = 3;

  // Total count of observations in this time bucket
  uint64 count = 4;

  // Sum of all observed values in this time bucket
  double sum = 5;
}

// Prometheus-style cumulative histogram bucket
message HistogramBucket {
  // Upper bound (le = "less than or equal to")
  // Use special value +Inf (represented as max float64) for the last bucket
  double le = 1;

  // Cumulative count of observations <= le
  uint64 cumulative_count = 2;
}

// Query metadata
message QueryMetadata {
  // Total number of data points across all time buckets
  uint64 total_count = 1;

  // Time bucket interval that was auto-calculated
  google.protobuf.Duration time_bucket_interval = 2;

  // Number of time buckets returned
  uint32 time_bucket_count = 3;

  // Number of devices included in the query
  uint32 device_count = 4;
}

// EndDeviceDataService handles querying and analyzing sensor data from devices
service EndDeviceDataService {
  // Query end device data with histogram aggregation for visualization
  rpc QueryEndDeviceData(QueryEndDeviceDataRequest) returns (QueryEndDeviceDataResponse);
}
